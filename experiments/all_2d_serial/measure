#! /usr/bin/env python

import itertools as it

from firedrake.petsc import PETSc
import numpy as np

import fireperf.assemble
import fireperf.form
import fireperf.mesh
import fireperf.log


FORM_TYPES = fireperf.form.FORM_TYPES
MESH_TYPES = fireperf.mesh.MESH_TYPES_2D
MESH_SIZES_1D = np.logspace(2, 12, 15, base=2, dtype=np.int)
DEGREE = 1
USE_ACTION = False
REPEATS = 5

PETSc.Log.begin()


# Do a warm start.
for _ in range(3):
    fireperf.assemble.assemble_form("helmholtz", "tri", (256, 256), 1, False, 5)

# Do the main run.
mesh_sizes = zip(MESH_SIZES_1D, MESH_SIZES_1D)
params = it.product(FORM_TYPES, MESH_TYPES, mesh_sizes)

for form_type, mesh_type, mesh_size in params:
    stage = f"{form_type} {mesh_type} {mesh_size}" 

    print(stage)

    with PETSc.Log.Stage(stage):
        dof = fireperf.assemble.assemble_form(form_type, mesh_type, mesh_size, 
                                            DEGREE, USE_ACTION, REPEATS)

    log_fname = f"{form_type}_{mesh_type}_{dof}.txt"
    meta_fname = "metadata.csv"

fireperf.log.write(log_fname)
fireperf.log.write_metadata(meta_fname, log_fname, form_type, mesh_type,
                                DEGREE, dof)
